<html>
  <head>
    <script type="text/javascript" src="https://svn3.lightning.force.com/support/api/63.0/lightning/opencti_min.js"></script>
    <script type="text/javascript" src="https://svn3.lightning.force.com/soap/ajax/63.0/connection.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

    <script>
      let isClickToDialEnabled = false;
      var enableClickToDialCallback = function (response) {
        if (response.success) {
          isClickToDialEnabled = true;
          console.log(
            "API method call executed successfully! returnValue:",
            response.returnValue
          );
        } else {
          console.error("Something went wrong! Errors:", response.errors);
        }
      };

      var disableClickToDialCallback = function (response) {
        if (response.success) {
          console.log(
            "API method call executed successfully! returnValue:",
            response.returnValue
          );
        } else {
          console.error("Something went wrong! Errors:", response.errors);
        }
        isClickToDialEnabled = false;
      };
      function toggleClickToDial() {
        if (isClickToDialEnabled) {
          sforce.opencti.disableClickToDial({
            callback: disableClickToDialCallback,
          });
        } else {
          sforce.opencti.enableClickToDial({
            callback: enableClickToDialCallback,
          });
        }
      }


function callback(response) {
      console.log("Resposta do runApex:", JSON.stringify(response, null, 2));  
const email = response.returnValue.runApex; 
// Obtém o email do retorno            
// Chama fetchTokenByEmail com o email obtido
            fetchTokenByEmail(email);        
}

function runApex() {
  const param = {
    apexClass: "AccountRetrieval",
    methodName: "getAccount",
    callback: callback
  };

  sforce.opencti.runApex(param);
}

    
const supabaseUrl = 'https://dbtifvsodujcktmxoswl.supabase.co'; 
// Substitua pela URL do seu projeto
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRidGlmdnNvZHVqY2t0bXhvc3dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY4NTg5NDksImV4cCI6MjA0MjQzNDk0OX0.nqStQuofSwfnSk0ixvgT3qMfybGVZN57id8c4rjklhI'; 
// Substitua pela sua chave pública
       
const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
async function fetchTokenByEmail(email) {
            
const { data, error } = await supabase               
  .from('user_token')
  .select('token')
  .eq('email', email);
            
if (error) {
    console.error('Erro ao buscar o token:', error);
    } else {
   console.log('Token encontrado:', data);
            }
        }
// Chame a função com o email desejado
fetchTokenByEmail('email@example.com'); 


      
  // Executa ao abrir a janela
  window.onload = function () {
    toggleClickToDial();
  };
      
    </script>
  </head>
  <body>
      <button onclick="toggleClickToDial();">Toggle Click to Dial</button>
      <button onclick="getUser()">Get User Info</button>
      <button onclick="runApex()">Run Apex</button>
      <button onclick="buscarUsuarioPorEmail()">Dados usuário</button>
    
  </body>
</html>
