<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type="text/javascript" src="https://svn3.lightning.force.com/support/api/63.0/lightning/opencti_min.js"></script>
    <script type="text/javascript" src="https://svn3.lightning.force.com/soap/ajax/63.0/connection.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/supabase.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
  <meta charset="UTF-8">
  <title>Discador SVN</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }

    iframe {
      margin: 5px auto 5px;
      border: none;
      width: 100%;
      height: 60px;
    }

    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 16px;
      text-align: center;
    }

    .teclado {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .tecla {
      padding: 15px;
      font-size: 18px;
      background-color: #f0f0f0;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tecla:hover {
      background-color: #ddd;
      transform: scale(1.05);
    }

    .botoes {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .botoes button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

.botoes-container {
  width: 100%;
  padding: 0 5px;
  box-sizing: border-box;
}

.btn-login {
  background-color: #4E6369;
  color: white;
  width: 100%;
  padding: 8px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  margin-bottom: 8px;
}

.botoes-ligacao {
  display: flex;
  width: 100%; /* <-- garantir que o container ocupa tudo */
  gap: 8px;
}

.btn-ligar,
.btn-desligar {
  flex: 1; /* <-- for√ßa cada bot√£o ocupar metade */
  padding: 8px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  color: white;
  width: 100%; /* <-- importante: garantir que o bot√£o estica */
}

.btn-ligar {
  background-color: #A17C6B;
}

.btn-desligar {
  background-color: #937356;
}

.btn {
  cursor: pointer;
}
.status-text {
  margin-top: 10px;
  background: #f5f5f5;
  border-radius: 8px;
  padding: 8px;
  width: 100%;
  font-size: 14px;
  text-align: center;
  box-sizing: border-box;
  white-space: pre-wrap;
}      

    pre {
      text-align: left;
      background: #f0f0f0;
      padding: 8px;
      border-radius: 6px;
      height: 40px;
      overflow: auto;
      font-size: 14px;
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>

  <!-- Open CTI e Interaction -->
  <script src="https://svn3.lightning.force.com/support/api/63.0/lightning/opencti_min.js"></script>
  <script src="http://svn3.lightning.force.com/support/api/25.0/interaction.js"></script>
</head>
<body>
  <div class="container">
    <iframe id="iframe3c" allow="microphone"></iframe>
      
    <div style="display: flex; align-items: center; gap: 10px;">
      <input type="text" id="digitarNumero" placeholder="Digite o n√∫mero aqui...">
      <button onclick="apagarUltimoDigito()">‚å´</button>
    </div>
      

    <div class="teclado">
      <button class="tecla" onclick="addNumero('1')">1</button>
      <button class="tecla" onclick="addNumero('2')">2</button>
      <button class="tecla" onclick="addNumero('3')">3</button>
      <button class="tecla" onclick="addNumero('4')">4</button>
      <button class="tecla" onclick="addNumero('5')">5</button>
      <button class="tecla" onclick="addNumero('6')">6</button>
      <button class="tecla" onclick="addNumero('7')">7</button>
      <button class="tecla" onclick="addNumero('8')">8</button>
      <button class="tecla" onclick="addNumero('9')">9</button>
      <button class="tecla" onclick="addNumero('*')">*</button>
      <button class="tecla" onclick="addNumero('0')">0</button>
      <button class="tecla" onclick="addNumero('#')">#</button>
    </div>

<div class="botoes-container">
  <button class="btn btn-login" onclick="fazerLogin()">Login</button>

  <div class="botoes-ligacao">
    <button class="btn btn-ligar" onclick="fazerLigacao()">üìû Ligar</button>
    <button class="btn btn-desligar" onclick="encerrarLigacao()" >‚òéÔ∏è Desligar</button>
  </div>
     <pre id="resposta" class="status-text"></pre>
</div>

  <script>

const socket = io('https://socket.3c.plus', {
  transports: ['websocket'],
  query: { token: '4uDSb4y4L5dj4im7DTEiDRqGGVuDi5BdnDh2ap8EnyOTqCO61OxvprAVfLwz' },
  
});
// Debugging: Captura todos os eventos WebSocket.io
socket.onAny((eventName, ...args) => {
console.log(`Evento: ${eventName}`, args);
resposta.textContent = `${eventName}`;
});

function displayEvent(eventName) {
  let message = '';
  switch (eventName) {
    case 'agent-was-logged-out':
      message = 'Desconectado - clique em Login.';
      break;
    case 'agent-entered-manual':
      message = 'Logado - aguardando liga√ß√£o.';
      break;
    case 'call-was-created':
      message = 'Nova chamada iniciada.';
      break;
    case 'call-is-trying':
      message = 'Tentando conectar a liga√ß√£o...';
      break;
    case 'call-was-connected':
      message = 'Chamada conectada!';
      break;
    case 'call-was-answered':
      message = 'Chamada atendida pelo cliente.';
      break;
    case 'call-was-abandoned':
      message = 'Chamada abandonada.';
      break;
    case 'call-was-not-answered':
      message = 'Chamada n√£o atendida.';
      break;
    case 'call-was-finished':
      message = 'Chamada finalizada.';
      break;
    case 'call-was-ended':
      message = 'Chamada desligada.';
      break;
    case 'agent-is-idle':
      message = 'Logado - aguardando liga√ß√£o.';
      break;
    case 'call-history-was-created':
      message = 'Hist√≥rico da chamada registrado.';
      break;
    default:
      message = `${eventName}`;
      console.log('Evento n√£o mapeado:', eventName);
  }
    resposta.textContent = `${message}`;
}
      
    let globalToken = null;
    let currentCallId = null;
    let idRegistro = null;
    let userId = null;
    let isClickToDialEnabled = false;
      
// Ao carregar a p√°gina
// 1. Ligar o clicktToCall
// 2. Pega o e-mail do usu√°rio
// 3. Fica escutando o click em qualquer n√∫mero da tela

window.onload = function () {
    sforce.opencti.enableClickToDial({
      callback: function (response) {
        if (response.success) {
          isClickToDialEnabled = true;
          console.log("‚úÖ Click-to-Dial habilitado com sucesso.");
        } else {
          console.error("‚ùå Erro ao habilitar Click-to-Dial:", response.errors);
        }
      }
    });
    runApex(); // Captura o e-mail do usu√°rio  
    sforce.opencti.onClickToDial({
      listener: function (payload) {
      sforce.opencti.setSoftphonePanelVisibility({visible:true});  
      const numeroClicado = payload.number;
      idRegistro = payload.recordId;
      const numeroFormatado = formatNumber(numeroClicado);
          console.log('N√∫mero formatado:', numeroFormatado);
          console.log('Id do registro:', idRegistro);
          
      document.getElementById('digitarNumero').value = numeroFormatado;
    }
  });
  };
      
function runApex() {
  const param = {
    apexClass: "AccountRetrieval",
    methodName: "getAccount",
    callback: callback
  };

  sforce.opencti.runApex(param);
};

function callback(response) {
      console.log("Resposta do runApex:", JSON.stringify(response, null, 2));  
const email = response.returnValue.runApex; // Obt√©m o email do usu√°rio            
fetchTokenByEmail(email); // Busca o token
fetchIdByEmail(email); // Busca o id > OwnerId

};
      
// Busca o token no Supabase pelo o e-mail
    async function fetchTokenByEmail(email) {
    console.log('Buscando token para o email:', email);
      const { data, error } = await supabaseClient
        .from('user_token')
        .select('token')
        .eq('email', email);
      if (error) {
        console.error('Erro ao buscar o token:', error);
      } else {
        globalToken = data[0].token;
        console.log('Token encontrado:', globalToken);
      }
    carregarIframeComToken();
    };

    function carregarIframeComToken() {
      if (globalToken) {
        const iframe = document.getElementById("iframe3c");
        const url = `https://svninvestimentos1.3c.plus/extension?api_token=${globalToken}`;
        iframe.src = url;

      } else {
        console.warn("Token ainda n√£o dispon√≠vel.");
      }
    };

  async function fetchIdByEmail(email) {
    console.log('Buscando Id para o email:', email);
      const { data, error } = await supabaseClient
        .from('user_token')
        .select('userId')
        .eq('email', email);
      if (error) {
        console.error('Erro ao buscar o Id:', error);
      } else {
        userId = data[0].userId;
        console.log('Id encontrado:', userId);
      }
    }; 
      
    async function fazerLogin() {
        resposta.textContent = '‚è≥ Fazendo login...';
        console.log("‚è≥ Fazendo login...");
        
        await new Promise(resolve => setTimeout(resolve, 2000)); // Pausa de 2 segundos

      try {
        const res = await fetch(`https://svninvestimentos1.3c.plus/api/v1/agent/login?api_token=${globalToken}`, {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            campaign: "172523",
            mode: "manual"
          })
        });

        const texto = await res.text(); // Pegando a resposta da requisi√ß√£o de LOGIN
        console.log("Resposta do login:", texto);

      } catch (err) {
        console.error("Resposta do login:", err);
      }
    };

async function fazerLigacao() {
  const numero = document.getElementById('digitarNumero').value;

  if (!numero) {
    resposta.textContent = "‚ö†Ô∏è Digite um n√∫mero antes de ligar.";
    return;
  }

  await new Promise(resolve => setTimeout(resolve, 2000));
    
  try {
    const res = await fetch(`https://svninvestimentos1.3c.plus/api/v1/agent/manual_call/dial?api_token=${globalToken}`, {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ phone: numero })
    });

    const data = await res.json();

    // Verifica se a requisi√ß√£o foi bem-sucedida
    if (data.status === 200 && data.call) {
      console.log(data);
      
      currentCallId  = data.call.id; // ID da chamada
      const callNumber = data.call.number; // N√∫mero da chamada
      const transactionId = data.transaction_id; // ID da transa√ß√£o
      const agentName = data.agent.name; // Nome do agente
      const agentTelephonyId = data.agent.telephony_id; // ID do agente

      // Exibe informa√ß√µes detalhadas da chamada
      console.log(`üìû Call ID: ${currentCallId}`);
      console.log(`üìû N√∫mero da chamada: ${callNumber}`);
      console.log(`üìû Transaction ID: ${transactionId}`);
      console.log(`üìû Agente: ${agentName} (ID: ${agentTelephonyId})`);
        
      runTaskCreator();

    } else {
      console.log(data);
    }

  } catch (err) {
    console.log(err.message);
  }
};

function runTaskCreator() {
        console.log("userId:", userId);
        console.log("idRegistro:", idRegistro);
        console.log("currentCallId:", currentCallId);
    const activityDate = new Date().toISOString().split('T')[0];
    const subject = "Chamada3C+Tentativa";
    const param = {
    apexClass: "TaskCreator",
    methodName: "createTask",
    methodParams: `recordId=${idRegistro}&ownerId=${userId}&subject=${subject}&activityDate=${activityDate}&currentCallId=${currentCallId}`,
    callback: function(response) {
      console.log("Tarefa criada:", JSON.stringify(response, null, 2));
    }
  };
  console.log("param:", param); 
  sforce.opencti.runApex(param);
}

async function encerrarLigacao() {
  if (!currentCallId) {
    resposta.textContent = "‚ö†Ô∏è Voc√™ n√£o est√° em liga√ß√£o.";
    return;
  }

  try {
    const res = await fetch(`https://svninvestimentos1.3c.plus/api/v1/agent/call/${currentCallId}/hangup?api_token=${globalToken}`, {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ call_id: currentCallId })
    });

    const data = await res.text();
    if (data.success) {
      currentCallId = null;
    } else {
      console.log("Encerrar liga√ß√£o:", data);  
    }
  } catch (err) {
    console.log("Encerrar liga√ß√£o:", err);
  }
};
      
function formatNumber(telefone) { 
    return telefone.replace(/\D/g, ""); // remove os parenteses, tra√ßos e espa√ßos
}
function apagarUltimoDigito() {
    const input = document.getElementById('digitarNumero');
    input.value = input.value.slice(0, -1);
}

// Inicializa o Supabase
const { createClient } = supabase; 
const supabaseUrl = 'https://dbtifvsodujcktmxoswl.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRidGlmdnNvZHVqY2t0bXhvc3dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY4NTg5NDksImV4cCI6MjA0MjQzNDk0OX0.nqStQuofSwfnSk0ixvgT3qMfybGVZN57id8c4rjklhI'; // sua chave
const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
    

      
const resposta = document.getElementById('resposta'); //Todas as respostas de requisi√ß√µes mandam o resultado pra "resposta"

function addNumero(num) {
    const campo = document.getElementById('digitarNumero');
    campo.value += num;
}

  </script>
</body>
</html>
